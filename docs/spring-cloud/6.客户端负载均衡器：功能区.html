<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>6.客户端负载均衡器：功能区 | My study notes</title>
    <meta name="description" content="我的学习笔记">
    
    
    <link rel="preload" href="/assets/css/0.styles.e8533c4d.css" as="style"><link rel="preload" href="/assets/js/app.92c16ba4.js" as="script"><link rel="preload" href="/assets/js/2.8d1f79e6.js" as="script"><link rel="preload" href="/assets/js/57.5cd33601.js" as="script"><link rel="prefetch" href="/assets/js/10.5b81e484.js"><link rel="prefetch" href="/assets/js/11.d21216c4.js"><link rel="prefetch" href="/assets/js/12.7cf205ef.js"><link rel="prefetch" href="/assets/js/13.4d4df7b4.js"><link rel="prefetch" href="/assets/js/14.66da89f0.js"><link rel="prefetch" href="/assets/js/15.8a625dc9.js"><link rel="prefetch" href="/assets/js/16.5f0bfba9.js"><link rel="prefetch" href="/assets/js/17.0cfdd523.js"><link rel="prefetch" href="/assets/js/18.c26cb110.js"><link rel="prefetch" href="/assets/js/19.d1d0ed32.js"><link rel="prefetch" href="/assets/js/20.cd4c2330.js"><link rel="prefetch" href="/assets/js/21.79998be3.js"><link rel="prefetch" href="/assets/js/22.e5b19c1f.js"><link rel="prefetch" href="/assets/js/23.f275b36d.js"><link rel="prefetch" href="/assets/js/24.51bc0420.js"><link rel="prefetch" href="/assets/js/25.e4bc309e.js"><link rel="prefetch" href="/assets/js/26.39026d2c.js"><link rel="prefetch" href="/assets/js/27.58e25151.js"><link rel="prefetch" href="/assets/js/28.516d4bd0.js"><link rel="prefetch" href="/assets/js/29.be107138.js"><link rel="prefetch" href="/assets/js/3.f9d23b82.js"><link rel="prefetch" href="/assets/js/30.0a234c73.js"><link rel="prefetch" href="/assets/js/31.26abbc05.js"><link rel="prefetch" href="/assets/js/32.f682bcb3.js"><link rel="prefetch" href="/assets/js/33.61e062be.js"><link rel="prefetch" href="/assets/js/34.52dbee47.js"><link rel="prefetch" href="/assets/js/35.3eab3e90.js"><link rel="prefetch" href="/assets/js/36.d44ce974.js"><link rel="prefetch" href="/assets/js/37.65f1dc57.js"><link rel="prefetch" href="/assets/js/38.55ea078e.js"><link rel="prefetch" href="/assets/js/39.daab600f.js"><link rel="prefetch" href="/assets/js/4.863ac15b.js"><link rel="prefetch" href="/assets/js/40.306e4a80.js"><link rel="prefetch" href="/assets/js/41.9b496698.js"><link rel="prefetch" href="/assets/js/42.1aa6c885.js"><link rel="prefetch" href="/assets/js/43.760cd03c.js"><link rel="prefetch" href="/assets/js/44.1324cfcb.js"><link rel="prefetch" href="/assets/js/45.1ca23e4e.js"><link rel="prefetch" href="/assets/js/46.0ef6f069.js"><link rel="prefetch" href="/assets/js/47.e5bf2701.js"><link rel="prefetch" href="/assets/js/48.3bbedfb1.js"><link rel="prefetch" href="/assets/js/49.d76f3dca.js"><link rel="prefetch" href="/assets/js/5.db008366.js"><link rel="prefetch" href="/assets/js/50.87ae6da4.js"><link rel="prefetch" href="/assets/js/51.a6941102.js"><link rel="prefetch" href="/assets/js/52.60407294.js"><link rel="prefetch" href="/assets/js/53.94e43400.js"><link rel="prefetch" href="/assets/js/54.3c3f64ae.js"><link rel="prefetch" href="/assets/js/55.47a6ab5b.js"><link rel="prefetch" href="/assets/js/56.35f0bb8d.js"><link rel="prefetch" href="/assets/js/58.0d0a6de3.js"><link rel="prefetch" href="/assets/js/59.5c6300ce.js"><link rel="prefetch" href="/assets/js/6.a5020f34.js"><link rel="prefetch" href="/assets/js/60.f8be88d7.js"><link rel="prefetch" href="/assets/js/61.3ec5a0b7.js"><link rel="prefetch" href="/assets/js/62.a49a64b4.js"><link rel="prefetch" href="/assets/js/7.4dd735d9.js"><link rel="prefetch" href="/assets/js/8.6d6c85ae.js"><link rel="prefetch" href="/assets/js/9.acd1abaf.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e8533c4d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">My study notes</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/catalogue.html" class="nav-link">目录</a></div><div class="nav-item"><a href="/log.html" class="nav-link">日志</a></div> <a href="https://github.com/han1396735592/docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    贡献代码！
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/catalogue.html" class="nav-link">目录</a></div><div class="nav-item"><a href="/log.html" class="nav-link">日志</a></div> <a href="https://github.com/han1396735592/docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    贡献代码！
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>总目录</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/spring-boot/" class="sidebar-link">spring-boot</a></li><li><a href="/java/" class="sidebar-link">java</a></li><li><a href="/docker/" class="sidebar-link">docker</a></li><li><a href="/linux/" class="sidebar-link">linux</a></li><li><a href="/springmvc/" class="sidebar-link">springmvc</a></li><li><a href="/mysql/" class="sidebar-link">mysql</a></li><li><a href="/stm32/" class="sidebar-link">stm32</a></li><li><a href="/spring-cloud/" class="sidebar-link">spring-cloud</a></li><li><a href="/other/" class="sidebar-link">other</a></li><li><a href="/dubbo/" class="sidebar-link">dubbo</a></li><li><a href="/interview/" class="sidebar-link">面试题</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_6-客户端负载均衡器：功能区"><a href="#_6-客户端负载均衡器：功能区" aria-hidden="true" class="header-anchor">#</a> 6.客户端负载均衡器：功能区</h1> <p>Ribbon是一个客户端负载均衡器，可以让您对HTTP和TCP客户端的行为进行大量控制。Feign已经使用了Ribbon，因此，如果您使用<code>@FeignClient</code>，本节也适用。</p> <p>Ribbon中的一个核心概念是指定客户端的概念。每个负载均衡器都是一组组件的一部分，这些组件一起工作以按需联系远程服务器，并且该集合具有您作为应用程序开发人员提供的名称（例如，通过使用<code>@FeignClient</code>注释）。根据需要，Spring Cloud <code>ApplicationContext</code>通过使用为每个命名客户端 创建一个新的集合<code>RibbonClientConfiguration</code>。这包含（除其他外）a <code>ILoadBalancer</code>，a <code>RestClient</code>和a <code>ServerListFilter</code>。</p> <h2 id="_6-1如何包含功能区"><a href="#_6-1如何包含功能区" aria-hidden="true" class="header-anchor">#</a> 6.1如何包含功能区</h2> <p>要在项目中包含Ribbon，请使用组ID为ID <code>org.springframework.cloud</code>且工件ID为的starter <code>spring-cloud-starter-netflix-ribbon</code>。有关使用当前Spring Cloud Release Train设置构建系统的详细信息，请参阅<a href="https://projects.spring.io/spring-cloud/" target="_blank" rel="noopener noreferrer">Spring Cloud Project页面<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h2 id="_6-2自定义功能区客户端"><a href="#_6-2自定义功能区客户端" aria-hidden="true" class="header-anchor">#</a> 6.2自定义功能区客户端</h2> <p>您可以使用外部属性配置Ribbon客户端的某些位<code>&lt;client&gt;.ribbon.*</code>，这类似于本机使用Netflix API，但您可以使用Spring Boot配置文件。可以将本机选项作为静态字段<a href="https://github.com/Netflix/ribbon/blob/master/ribbon-core/src/main/java/com/netflix/client/config/CommonClientConfigKey.java" target="_blank" rel="noopener noreferrer"><code>CommonClientConfigKey</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>（带状内核的一部分）进行检查。</p> <p>Spring Cloud还允许您通过声明其他配置（在其上方<code>RibbonClientConfiguration</code>）来完全控制客户端<code>@RibbonClient</code>，如以下示例所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@RibbonClient</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;custom&quot;</span><span class="token punctuation">,</span> configuration <span class="token operator">=</span> <span class="token class-name">CustomConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestConfiguration</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>在这种情况下，客户端由已经存在的组件<code>RibbonClientConfiguration</code>以及任何in组成<code>CustomConfiguration</code>（其中后者通常覆盖前者）。</p> <table><thead><tr><th><img src="http://cloud.spring.io/spring-cloud-netflix/single/images/warning.png" alt="[警告]"></th></tr></thead> <tbody><tr><td>该<code>CustomConfiguration</code>CLAS必须是<code>@Configuration</code>一流的，但照顾，这是不是在<code>@ComponentScan</code>主应用程序上下文。否则，它由所有人共享<code>@RibbonClients</code>。如果使用<code>@ComponentScan</code>（或<code>@SpringBootApplication</code>），则需要采取措施以避免包含它（例如，您可以将其放在单独的非重叠包中，或指定要在其中显式扫描的包<code>@ComponentScan</code>）。</td></tr></tbody></table> <p>下表显示了Spring Cloud Netflix默认为Ribbon提供的bean：</p> <table><thead><tr><th>Bean Type</th> <th>Bean Name</th> <th>Class Name</th></tr></thead> <tbody><tr><td><code>IClientConfig</code></td> <td><code>ribbonClientConfig</code></td> <td><code>DefaultClientConfigImpl</code></td></tr> <tr><td><code>IRule</code></td> <td><code>ribbonRule</code></td> <td><code>ZoneAvoidanceRule</code></td></tr> <tr><td><code>IPing</code></td> <td><code>ribbonPing</code></td> <td><code>DummyPing</code></td></tr> <tr><td><code>ServerList&lt;Server&gt;</code></td> <td><code>ribbonServerList</code></td> <td><code>ConfigurationBasedServerList</code></td></tr> <tr><td><code>ServerListFilter&lt;Server&gt;</code></td> <td><code>ribbonServerListFilter</code></td> <td><code>ZonePreferenceServerListFilter</code></td></tr> <tr><td><code>ILoadBalancer</code></td> <td><code>ribbonLoadBalancer</code></td> <td><code>ZoneAwareLoadBalancer</code></td></tr> <tr><td><code>ServerListUpdater</code></td> <td><code>ribbonServerListUpdater</code></td> <td><code>PollingServerListUpdater</code></td></tr></tbody></table> <p>创建其中一种类型的bean并将其置于<code>@RibbonClient</code>配置（<code>FooConfiguration</code>如上所述）中，可以覆盖所描述的每个bean，如以下示例所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">FooConfiguration</span> <span class="token punctuation">{</span>
	<span class="token annotation punctuation">@Bean</span>
	<span class="token keyword">public</span> <span class="token class-name">ZonePreferenceServerListFilter</span> <span class="token function">serverListFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">ZonePreferenceServerListFilter</span> filter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZonePreferenceServerListFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		filter<span class="token punctuation">.</span><span class="token function">setZone</span><span class="token punctuation">(</span><span class="token string">&quot;myTestZone&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> filter<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Bean</span>
	<span class="token keyword">public</span> <span class="token class-name">IPing</span> <span class="token function">ribbonPing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PingUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>前面示例中的include语句替换<code>NoOpPing</code>为<code>PingUrl</code>并提供自定义<code>serverListFilter</code>。</p> <h2 id="_6-3自定义所有功能区客户端的默认值"><a href="#_6-3自定义所有功能区客户端的默认值" aria-hidden="true" class="header-anchor">#</a> 6.3自定义所有功能区客户端的默认值</h2> <p>可以使用<code>@RibbonClients</code>注释并注册默认配置为所有功能区客户端提供默认配置，如以下示例所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RibbonClients</span><span class="token punctuation">(</span>defaultConfiguration <span class="token operator">=</span> <span class="token class-name">DefaultRibbonConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RibbonClientDefaultConfigurationTestsConfig</span> <span class="token punctuation">{</span>

	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">BazServiceList</span> <span class="token keyword">extends</span> <span class="token class-name">ConfigurationBasedServerList</span> <span class="token punctuation">{</span>
		<span class="token keyword">public</span> <span class="token class-name">BazServiceList</span><span class="token punctuation">(</span><span class="token class-name">IClientConfig</span> config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">initWithNiwsConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">class</span> <span class="token class-name">DefaultRibbonConfig</span> <span class="token punctuation">{</span>

	<span class="token annotation punctuation">@Bean</span>
	<span class="token keyword">public</span> <span class="token class-name">IRule</span> <span class="token function">ribbonRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BestAvailableRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Bean</span>
	<span class="token keyword">public</span> <span class="token class-name">IPing</span> <span class="token function">ribbonPing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PingUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Bean</span>
	<span class="token keyword">public</span> <span class="token class-name">ServerList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token function">ribbonServerList</span><span class="token punctuation">(</span><span class="token class-name">IClientConfig</span> config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RibbonClientDefaultConfigurationTestsConfig</span><span class="token punctuation">.</span><span class="token class-name">BazServiceList</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Bean</span>
	<span class="token keyword">public</span> <span class="token class-name">ServerListSubsetFilter</span> <span class="token function">serverListFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token class-name">ServerListSubsetFilter</span> filter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerListSubsetFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> filter<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h2 id="_6-4通过设置属性自定义功能区客户端"><a href="#_6-4通过设置属性自定义功能区客户端" aria-hidden="true" class="header-anchor">#</a> 6.4通过设置属性自定义功能区客户端</h2> <p>从版本1.2.0开始，Spring Cloud Netflix现在支持通过将属性设置为与<a href="https://github.com/Netflix/ribbon/wiki/Working-with-load-balancers#components-of-load-balancer" target="_blank" rel="noopener noreferrer">Ribbon文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>兼容来自定义功能区客户端。</p> <p>这使您可以在不同环境中的启动时更改行为。</p> <p>以下列表显示了支持的属性&gt;：</p> <ul><li><code>&lt;clientName&gt;.ribbon.NFLoadBalancerClassName</code>：应该实施 <code>ILoadBalancer</code></li> <li><code>&lt;clientName&gt;.ribbon.NFLoadBalancerRuleClassName</code>：应该实施 <code>IRule</code></li> <li><code>&lt;clientName&gt;.ribbon.NFLoadBalancerPingClassName</code>：应该实施 <code>IPing</code></li> <li><code>&lt;clientName&gt;.ribbon.NIWSServerListClassName</code>：应该实施 <code>ServerList</code></li> <li><code>&lt;clientName&gt;.ribbon.NIWSServerListFilterClassName</code>：应该实施 <code>ServerListFilter</code></li></ul> <table><thead><tr><th><img src="http://cloud.spring.io/spring-cloud-netflix/single/images/note.png" alt="[注意]"></th></tr></thead> <tbody><tr><td>这些属性中定义的类优先于使用<code>@RibbonClient(configuration=MyRibbonConfig.class)</code>Spring 定义的bean 和Spring Cloud Netflix提供的缺省值。</td></tr></tbody></table> <p>要设置<code>IRule</code>名为的服务名称<code>users</code>，您可以设置以下属性：</p> <p><strong>application.yml。</strong></p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">users</span><span class="token punctuation">:</span>
  <span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
    <span class="token key atrule">NIWSServerListClassName</span><span class="token punctuation">:</span> com.netflix.loadbalancer.ConfigurationBasedServerList
    <span class="token key atrule">NFLoadBalancerRuleClassName</span><span class="token punctuation">:</span> com.netflix.loadbalancer.WeightedResponseTimeRule
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>有关<a href="https://github.com/Netflix/ribbon/wiki/Working-with-load-balancers" target="_blank" rel="noopener noreferrer">Ribbon<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>提供的实现，请参阅<a href="https://github.com/Netflix/ribbon/wiki/Working-with-load-balancers" target="_blank" rel="noopener noreferrer">功能区文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h2 id="_6-5在eureka上使用ribbon"><a href="#_6-5在eureka上使用ribbon" aria-hidden="true" class="header-anchor">#</a> 6.5在Eureka上使用Ribbon</h2> <p>当Eureka与Ribbon一起使用时（也就是说，它们都在类路径上）时，<code>ribbonServerList</code>会被一个扩展名覆盖，该扩展<code>DiscoveryEnabledNIWSServerList</code>名将填充Eureka中的服务器列表。它还替换了<code>IPing</code>接口<code>NIWSDiscoveryPing</code>，该接口委托Eureka确定服务器是否已启动。该<code>ServerList</code>由默认安装的是<code>DomainExtractingServerList</code>。其目的是在不使用AWS AMI元数据的情况下使负载均衡器可以使用元数据（这是Netflix所依赖的）。默认情况下，服务器列表由“区域”信息构成，如实例元数据中所提供的（因此，在远程客户端上设置<code>eureka.instance.metadataMap.zone</code>）。如果缺少那个，如果<code>approximateZoneFromHostname</code>如果设置了标志，则可以使用服务器主机名中的域名作为区域的代理。区域信息可用后，可以在a中使用<code>ServerListFilter</code>。默认情况下，它用于在与客户端相同的区域中查找服务器，因为默认值为a <code>ZonePreferenceServerListFilter</code>。默认情况下，客户端的区域以与远程实例相同的方式确定（即，通过<code>eureka.instance.metadataMap.zone</code>）。</p> <table><thead><tr><th><img src="http://cloud.spring.io/spring-cloud-netflix/single/images/note.png" alt="[注意]"></th></tr></thead> <tbody><tr><td>设置客户区的正统“archaius”方法是通过名为“@zone”的配置属性。如果可用，Spring Cloud优先于所有其他设置使用它（请注意，必须在YAML配置中引用密钥）。</td></tr></tbody></table> <table><thead><tr><th><img src="http://cloud.spring.io/spring-cloud-netflix/single/images/note.png" alt="[注意]"></th></tr></thead> <tbody><tr><td>如果没有其他区域数据源，则根据客户端配置（与实例配置相反）进行猜测。我们采用<code>eureka.client.availabilityZones</code>从区域名称到区域列表的映射，并拉出实例自己区域的第一个区域（即<code>eureka.client.region</code>，默认为“us-east-1”，以与本机Netflix兼容） 。</td></tr></tbody></table> <h2 id="_6-6示例：如何在没有eureka的情况下使用功能区"><a href="#_6-6示例：如何在没有eureka的情况下使用功能区" aria-hidden="true" class="header-anchor">#</a> 6.6示例：如何在没有Eureka的情况下使用功能区</h2> <p>Eureka是一种抽象远程服务器发现的便捷方式，因此您无需在客户端中对其URL进行硬编码。但是，如果您不想使用Eureka，Ribbon和Feign也可以使用。假设您已经<code>@RibbonClient</code>为“商店” 声明了一个，并且Eureka没有被使用（甚至没有在类路径上）。功能区客户端默认为已配置的服务器列表。您可以按如下方式提供配置：</p> <p><strong>application.yml。</strong></p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">stores</span><span class="token punctuation">:</span>
  <span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
    <span class="token key atrule">listOfServers</span><span class="token punctuation">:</span> example.com<span class="token punctuation">,</span>google.com
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="_6-7示例：禁用功能区中的eureka使用"><a href="#_6-7示例：禁用功能区中的eureka使用" aria-hidden="true" class="header-anchor">#</a> 6.7示例：禁用功能区中的Eureka使用</h2> <p>设置该<code>ribbon.eureka.enabled</code>属性以<code>false</code>显式禁用在Ribbon中使用Eureka，如以下示例所示：</p> <p><strong>application.yml。</strong></p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
  <span class="token key atrule">eureka</span><span class="token punctuation">:</span>
   <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="_6-8直接使用ribbon-api"><a href="#_6-8直接使用ribbon-api" aria-hidden="true" class="header-anchor">#</a> 6.8直接使用Ribbon API</h2> <p>您也可以<code>LoadBalancerClient</code>直接使用，如下例所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyClass</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">LoadBalancerClient</span> loadBalancer<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doStuff</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ServiceInstance</span> instance <span class="token operator">=</span> loadBalancer<span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span><span class="token string">&quot;stores&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">URI</span> storesUri <span class="token operator">=</span> URI<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;http://%s:%s&quot;</span><span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> instance<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ... do something with the URI</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="_6-9缓存功能区配置"><a href="#_6-9缓存功能区配置" aria-hidden="true" class="header-anchor">#</a> 6.9缓存功能区配置</h2> <p>每个名为client的功能区都有一个Spring Cloud维护的相应子应用程序Context。此应用程序上下文在第一次请求指向客户端时被延迟加载。通过指定Ribbon客户端的名称，可以将此延迟加载行为更改为在启动时急切地加载这些子应用程序上下文，如以下示例所示：</p> <p><strong>application.yml。</strong></p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">ribbon</span><span class="token punctuation">:</span>
  <span class="token key atrule">eager-load</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">clients</span><span class="token punctuation">:</span> client1<span class="token punctuation">,</span> client2<span class="token punctuation">,</span> client3
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="_6-10如何配置hystrix线程池"><a href="#_6-10如何配置hystrix线程池" aria-hidden="true" class="header-anchor">#</a> 6.10如何配置Hystrix线程池</h2> <p>如果更改<code>zuul.ribbonIsolationStrategy</code>为<code>THREAD</code>，则Hystrix的线程隔离策略将用于所有路由。在这种情况下，将<code>HystrixThreadPoolKey</code>其设置<code>RibbonCommand</code>为默认值。这意味着所有路由的HystrixCommands都在同一个Hystrix线程池中执行。可以使用以下配置更改此行为：</p> <p><strong>application.yml。</strong></p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">zuul</span><span class="token punctuation">:</span>
  <span class="token key atrule">threadPool</span><span class="token punctuation">:</span>
    <span class="token key atrule">useSeparateThreadPools</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">threadPoolKeyPrefix</span><span class="token punctuation">:</span> zuulgw
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>前面的示例导致HystrixCommands在Hystrix线程池中为每个路由执行。</p> <p>在这种情况下，默认值<code>HystrixThreadPoolKey</code>与每个路由的服务ID相同。要添加前缀<code>HystrixThreadPoolKey</code>，请设置<code>zuul.threadPool.threadPoolKeyPrefix</code>为要添加的值，如以下示例所示：</p> <p><strong>application.yml。</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>zuul:
  threadPool:
    useSeparateThreadPools: true
    threadPoolKeyPrefix: zuulgw
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="_6-11如何为功能区提供密钥-irule"><a href="#_6-11如何为功能区提供密钥-irule" aria-hidden="true" class="header-anchor">#</a> 6.11如何为功能区提供密钥 <code>IRule</code></h2> <p>如果您需要提供自己的<code>IRule</code>实现来处理特殊的路由要求，如“canary”测试，请将一些信息传递给<code>choose</code>方法<code>IRule</code>。</p> <p><strong>com.netflix.loadbalancer.IRule.java。</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IRule</span><span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token operator">:</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>您可以提供<code>IRule</code>实现用于选择目标服务器的一些信息，如以下示例所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">RequestContext</span><span class="token punctuation">.</span><span class="token function">getCurrentContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">FilterConstants</span><span class="token punctuation">.</span>LOAD_BALANCER_KEY<span class="token punctuation">,</span> <span class="token string">&quot;canary-test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>如果将任何对象放入<code>RequestContext</code>带有键的对象中<code>FilterConstants.LOAD_BALANCER_KEY</code>，则将其传递给实现的<code>choose</code>方法<code>IRule</code>。必须在执行前<code>RibbonRoutingFilter</code>执行前面示例中显示的代码。Zuul的预过滤器是最好的选择。您可以通过<code>RequestContext</code>预过滤器访问HTTP标头和查询参数，因此可以使用它来确定<code>LOAD_BALANCER_KEY</code>传递给功能区的内容。如果未<code>LOAD_BALANCER_KEY</code>在in中输入任何值，则将<code>RequestContext</code>null作为<code>choose</code>方法的参数传递。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/han1396735592/docs/edit/master/spring-cloud/6.客户端负载均衡器：功能区.md" target="_blank" rel="noopener noreferrer">帮助我们改进页面内容！</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.92c16ba4.js" defer></script><script src="/assets/js/2.8d1f79e6.js" defer></script><script src="/assets/js/57.5cd33601.js" defer></script>
  </body>
</html>

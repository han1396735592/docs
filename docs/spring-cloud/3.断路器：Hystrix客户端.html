<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>3.断路器：Hystrix客户端</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.8c977ac8.css" as="style"><link rel="preload" href="/assets/js/app.483ccfe7.js" as="script"><link rel="preload" href="/assets/js/26.277384c0.js" as="script"><link rel="prefetch" href="/assets/js/10.c0241d73.js"><link rel="prefetch" href="/assets/js/11.4dddd1ea.js"><link rel="prefetch" href="/assets/js/12.c9fde8cc.js"><link rel="prefetch" href="/assets/js/13.64449cba.js"><link rel="prefetch" href="/assets/js/14.5b0e6879.js"><link rel="prefetch" href="/assets/js/15.cbe91458.js"><link rel="prefetch" href="/assets/js/16.5a176a64.js"><link rel="prefetch" href="/assets/js/17.7e87ff72.js"><link rel="prefetch" href="/assets/js/18.d9257a3c.js"><link rel="prefetch" href="/assets/js/19.fca155bc.js"><link rel="prefetch" href="/assets/js/2.e4c57591.js"><link rel="prefetch" href="/assets/js/20.66b43490.js"><link rel="prefetch" href="/assets/js/21.5d9cbf40.js"><link rel="prefetch" href="/assets/js/22.cf343007.js"><link rel="prefetch" href="/assets/js/23.8a6b6bec.js"><link rel="prefetch" href="/assets/js/24.f55ff1c2.js"><link rel="prefetch" href="/assets/js/25.45a8afcd.js"><link rel="prefetch" href="/assets/js/27.e1a96eba.js"><link rel="prefetch" href="/assets/js/28.9b742315.js"><link rel="prefetch" href="/assets/js/29.85462125.js"><link rel="prefetch" href="/assets/js/3.378533e8.js"><link rel="prefetch" href="/assets/js/30.84594bbe.js"><link rel="prefetch" href="/assets/js/31.c5339f48.js"><link rel="prefetch" href="/assets/js/4.5c2e9dad.js"><link rel="prefetch" href="/assets/js/5.8212f5d7.js"><link rel="prefetch" href="/assets/js/6.d8643fd5.js"><link rel="prefetch" href="/assets/js/7.ca5920ac.js"><link rel="prefetch" href="/assets/js/8.72606374.js"><link rel="prefetch" href="/assets/js/9.07612171.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8c977ac8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/catalogue/" class="nav-link">目录</a></div> <a href="https://github.com/han1396735592/docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    贡献代码！
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/catalogue/" class="nav-link">目录</a></div> <a href="https://github.com/han1396735592/docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    贡献代码！
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>3.断路器：Hystrix客户端</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/spring-cloud/3.%E6%96%AD%E8%B7%AF%E5%99%A8%EF%BC%9AHystrix%E5%AE%A2%E6%88%B7%E7%AB%AF.html#_3-1如何包含hystrix" class="sidebar-link">3.1如何包含Hystrix</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/spring-cloud/3.%E6%96%AD%E8%B7%AF%E5%99%A8%EF%BC%9AHystrix%E5%AE%A2%E6%88%B7%E7%AB%AF.html#_3-2传播安全上下文或使用spring-scopes" class="sidebar-link">3.2传播安全上下文或使用Spring Scopes</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/spring-cloud/3.%E6%96%AD%E8%B7%AF%E5%99%A8%EF%BC%9AHystrix%E5%AE%A2%E6%88%B7%E7%AB%AF.html#_3-3健康指标" class="sidebar-link">3.3健康指标</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/spring-cloud/3.%E6%96%AD%E8%B7%AF%E5%99%A8%EF%BC%9AHystrix%E5%AE%A2%E6%88%B7%E7%AB%AF.html#_3-4-hystrix指标流" class="sidebar-link">3.4 Hystrix指标流</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="_3-断路器：hystrix客户端"><a href="#_3-断路器：hystrix客户端" aria-hidden="true" class="header-anchor">#</a> 3.断路器：Hystrix客户端</h1> <p>Netflix创建了一个名为<a href="https://github.com/Netflix/Hystrix" target="_blank" rel="noopener noreferrer">Hystrix<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的库，用于实现<a href="http://martinfowler.com/bliki/CircuitBreaker.html" target="_blank" rel="noopener noreferrer">断路器模式<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。在微服务架构中，通常有多层服务调用，如以下示例所示：</p> <p><strong>图3.1。微服务图</strong></p> <p><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-netflix/master/docs/src/main/asciidoc/images/Hystrix.png" alt="豪猪"></p> <p>较低级别的服务中的服务故障可能导致级联故障一直到用户。当对特定服务的调用超过<code>circuitBreaker.requestVolumeThreshold</code>（默认值：20个请求）且故障百分比大于<code>circuitBreaker.errorThresholdPercentage</code>（默认值：&gt; 50％）在由<code>metrics.rollingStats.timeInMilliseconds</code>（默认值：10秒）定义的滚动窗口中时，电路将打开并且不会进行呼叫。在出现错误和开路的情况下，开发人员可以提供回退。</p> <p><strong>图3.2。Hystrix回退可防止级联故障</strong></p> <p><img src="https://raw.githubusercontent.com/spring-cloud/spring-cloud-netflix/master/docs/src/main/asciidoc/images/HystrixFallback.png" alt="HystrixFallback"></p> <p>开放式电路可以阻止级联故障，并且可以让不知所措或失败的服务有时间恢复。回退可以是另一个受Hystrix保护的调用，静态数据或合理的空值。可以链接回退，以便第一个回退进行一些其他业务调用，这反过来又回到静态数据。</p> <h2 id="_3-1如何包含hystrix"><a href="#_3-1如何包含hystrix" aria-hidden="true" class="header-anchor">#</a> 3.1如何包含Hystrix</h2> <p>要在项目中包含Hystrix，请使用组ID为ID <code>org.springframework.cloud</code> 且工件ID为的启动器<code>spring-cloud-starter-netflix-hystrix</code>。有关使用当前Spring Cloud Release Train设置构建系统的详细信息，请参阅<a href="https://projects.spring.io/spring-cloud/" target="_blank" rel="noopener noreferrer">Spring Cloud Project页面<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>以下示例显示了具有Hystrix断路器的最小Eureka服务器：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@EnableCircuitBreaker</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Application</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">SpringApplicationBuilder</span><span class="token punctuation">(</span>Application<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">web</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StoreIntegration</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@HystrixCommand</span><span class="token punctuation">(</span>fallbackMethod <span class="token operator">=</span> <span class="token string">&quot;defaultStores&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> Object <span class="token function">getStores</span><span class="token punctuation">(</span>Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">&gt;</span></span> parameters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//do stuff that might fail</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> Object <span class="token function">defaultStores</span><span class="token punctuation">(</span>Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">&gt;</span></span> parameters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token comment">/* something useful */</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>它<code>@HystrixCommand</code>由名为<a href="https://github.com/Netflix/Hystrix/tree/master/hystrix-contrib/hystrix-javanica" target="_blank" rel="noopener noreferrer">“javanica”<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的Netflix contrib库提供。Spring Cloud在连接到Hystrix断路器的代理中自动包装带有该注释的Spring bean。断路器计算何时打开和关闭电路以及在发生故障时应采取的措施。</p> <p>要配置，<code>@HystrixCommand</code>您可以将该<code>commandProperties</code> 属性与<code>@HystrixProperty</code>注释列表一起使用。有关 详细信息，请参见 <a href="https://github.com/Netflix/Hystrix/tree/master/hystrix-contrib/hystrix-javanica#configuration" target="_blank" rel="noopener noreferrer">此处 <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>有关 可用属性的详细信息，请参阅<a href="https://github.com/Netflix/Hystrix/wiki/Configuration" target="_blank" rel="noopener noreferrer">Hystrix wiki<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h2 id="_3-2传播安全上下文或使用spring-scopes"><a href="#_3-2传播安全上下文或使用spring-scopes" aria-hidden="true" class="header-anchor">#</a> 3.2传播安全上下文或使用Spring Scopes</h2> <p>如果您希望某些线程本地上下文传播到a <code>@HystrixCommand</code>，则默认声明不起作用，因为它在线程池中执行该命令（如果超时）。您可以通过配置或直接在注释中切换Hystrix以使用与调用者相同的线程，方法是要求它使用不同的“隔离策略”。以下示例演示如何在注释中设置线程：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@HystrixCommand</span><span class="token punctuation">(</span>fallbackMethod <span class="token operator">=</span> <span class="token string">&quot;stubMyService&quot;</span><span class="token punctuation">,</span>
    commandProperties <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token annotation punctuation">@HystrixProperty</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;execution.isolation.strategy&quot;</span><span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token string">&quot;SEMAPHORE&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p>如果您正在使用<code>@SessionScope</code>或，则同样适用<code>@RequestScope</code>。如果遇到运行时异常，表示无法找到作用域上下文，则需要使用相同的线程。</p> <p>您还可以选择将<code>hystrix.shareSecurityContext</code>属性设置为<code>true</code>。这样做会自动配置Hystrix并发策略插件挂钩，以将<code>SecurityContext</code>主线程转移到Hystrix命令使用的线程。Hystrix不会注册多个Hystrix并发策略，因此可以通过将自己声明<code>HystrixConcurrencyStrategy</code>为Spring bean 来获得扩展机制。Spring Cloud在Spring上下文中查找您的实现并将其包装在自己的插件中。</p> <h2 id="_3-3健康指标"><a href="#_3-3健康指标" aria-hidden="true" class="header-anchor">#</a> 3.3健康指标</h2> <p>连接断路器的状态也暴露在<code>/health</code>调用应用程序的端点中，如以下示例所示：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;hystrix&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;openCircuitBreakers&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">&quot;StoreIntegration::getStoresByLocationLink&quot;</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token string">&quot;CIRCUIT_OPEN&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token string">&quot;UP&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_3-4-hystrix指标流"><a href="#_3-4-hystrix指标流" aria-hidden="true" class="header-anchor">#</a> 3.4 Hystrix指标流</h2> <p>要启用Hystrix度量标准流，请包含依赖关系<code>spring-boot-starter-actuator</code>和设置 <code>management.endpoints.web.exposure.include: hystrix.stream</code>。这样做会将<code>/actuator/hystrix.stream</code>管理端点公开，如以下示例所示：</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/han1396735592/docs/edit/master/spring-cloud/3.断路器：Hystrix客户端.md" target="_blank" rel="noopener noreferrer">帮助我们改进页面内容！</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.483ccfe7.js" defer></script><script src="/assets/js/26.277384c0.js" defer></script>
  </body>
</html>

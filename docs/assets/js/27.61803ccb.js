(window.webpackJsonp=window.webpackJsonp||[]).push([[27],{191:function(t,s,a){"use strict";a.r(s);var n=a(0),r=Object(n.a)({},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"content"},[t._m(0),t._v(" "),a("p",[t._v("Netflix创建了一个名为"),a("a",{attrs:{href:"https://github.com/Netflix/Hystrix",target:"_blank",rel:"noopener noreferrer"}},[t._v("Hystrix"),a("OutboundLink")],1),t._v("的库，用于实现"),a("a",{attrs:{href:"http://martinfowler.com/bliki/CircuitBreaker.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("断路器模式"),a("OutboundLink")],1),t._v("。在微服务架构中，通常有多层服务调用，如以下示例所示：")]),t._v(" "),t._m(1),t._v(" "),t._m(2),t._v(" "),t._m(3),t._v(" "),t._m(4),t._v(" "),t._m(5),t._v(" "),a("p",[t._v("开放式电路可以阻止级联故障，并且可以让不知所措或失败的服务有时间恢复。回退可以是另一个受Hystrix保护的调用，静态数据或合理的空值。可以链接回退，以便第一个回退进行一些其他业务调用，这反过来又回到静态数据。")]),t._v(" "),t._m(6),t._v(" "),a("p",[t._v("要在项目中包含Hystrix，请使用组ID为ID "),a("code",[t._v("org.springframework.cloud")]),t._v(" 且工件ID为的启动器"),a("code",[t._v("spring-cloud-starter-netflix-hystrix")]),t._v("。有关使用当前Spring Cloud Release Train设置构建系统的详细信息，请参阅"),a("a",{attrs:{href:"https://projects.spring.io/spring-cloud/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Spring Cloud Project页面"),a("OutboundLink")],1),t._v("。")]),t._v(" "),a("p",[t._v("以下示例显示了具有Hystrix断路器的最小Eureka服务器：")]),t._v(" "),t._m(7),a("p",[t._v("它"),a("code",[t._v("@HystrixCommand")]),t._v("由名为"),a("a",{attrs:{href:"https://github.com/Netflix/Hystrix/tree/master/hystrix-contrib/hystrix-javanica",target:"_blank",rel:"noopener noreferrer"}},[t._v("“javanica”"),a("OutboundLink")],1),t._v("的Netflix contrib库提供。Spring Cloud在连接到Hystrix断路器的代理中自动包装带有该注释的Spring bean。断路器计算何时打开和关闭电路以及在发生故障时应采取的措施。")]),t._v(" "),a("p",[t._v("要配置，"),a("code",[t._v("@HystrixCommand")]),t._v("您可以将该"),a("code",[t._v("commandProperties")]),t._v(" 属性与"),a("code",[t._v("@HystrixProperty")]),t._v("注释列表一起使用。有关 详细信息，请参见 "),a("a",{attrs:{href:"https://github.com/Netflix/Hystrix/tree/master/hystrix-contrib/hystrix-javanica#configuration",target:"_blank",rel:"noopener noreferrer"}},[t._v("此处 "),a("OutboundLink")],1),t._v("有关 可用属性的详细信息，请参阅"),a("a",{attrs:{href:"https://github.com/Netflix/Hystrix/wiki/Configuration",target:"_blank",rel:"noopener noreferrer"}},[t._v("Hystrix wiki"),a("OutboundLink")],1),t._v("。")]),t._v(" "),t._m(8),t._v(" "),t._m(9),t._v(" "),t._m(10),t._m(11),t._v(" "),t._m(12),t._v(" "),t._m(13),t._v(" "),t._m(14),t._v(" "),t._m(15),t._m(16),t._v(" "),t._m(17),t._v(" "),t._m(18)])},[function(){var t=this.$createElement,s=this._self._c||t;return s("h1",{attrs:{id:"_3-断路器：hystrix客户端"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-断路器：hystrix客户端","aria-hidden":"true"}},[this._v("#")]),this._v(" 3.断路器：Hystrix客户端")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("strong",[this._v("图3.1。微服务图")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/spring-cloud/spring-cloud-netflix/master/docs/src/main/asciidoc/images/Hystrix.png",alt:"豪猪"}})])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("较低级别的服务中的服务故障可能导致级联故障一直到用户。当对特定服务的调用超过"),s("code",[this._v("circuitBreaker.requestVolumeThreshold")]),this._v("（默认值：20个请求）且故障百分比大于"),s("code",[this._v("circuitBreaker.errorThresholdPercentage")]),this._v("（默认值：> 50％）在由"),s("code",[this._v("metrics.rollingStats.timeInMilliseconds")]),this._v("（默认值：10秒）定义的滚动窗口中时，电路将打开并且不会进行呼叫。在出现错误和开路的情况下，开发人员可以提供回退。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("strong",[this._v("图3.2。Hystrix回退可防止级联故障")])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[s("img",{attrs:{src:"https://raw.githubusercontent.com/spring-cloud/spring-cloud-netflix/master/docs/src/main/asciidoc/images/HystrixFallback.png",alt:"HystrixFallback"}})])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"_3-1如何包含hystrix"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-1如何包含hystrix","aria-hidden":"true"}},[this._v("#")]),this._v(" 3.1如何包含Hystrix")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@EnableCircuitBreaker")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Application")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("String"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" args"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SpringApplicationBuilder")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Application"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("web")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("args"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Component")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("StoreIntegration")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@HystrixCommand")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fallbackMethod "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"defaultStores"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" Object "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getStores")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Map"),a("span",{pre:!0,attrs:{class:"token generics function"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("String"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Object"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" parameters"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//do stuff that might fail")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" Object "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("defaultStores")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Map"),a("span",{pre:!0,attrs:{class:"token generics function"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("String"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" Object"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" parameters"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* something useful */")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"_3-2传播安全上下文或使用spring-scopes"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2传播安全上下文或使用spring-scopes","aria-hidden":"true"}},[this._v("#")]),this._v(" 3.2传播安全上下文或使用Spring Scopes")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("如果您希望某些线程本地上下文传播到a "),s("code",[this._v("@HystrixCommand")]),this._v("，则默认声明不起作用，因为它在线程池中执行该命令（如果超时）。您可以通过配置或直接在注释中切换Hystrix以使用与调用者相同的线程，方法是要求它使用不同的“隔离策略”。以下示例演示如何在注释中设置线程：")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@HystrixCommand")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("fallbackMethod "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"stubMyService"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    commandProperties "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@HystrixProperty")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("name"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"execution.isolation.strategy"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" value"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"SEMAPHORE"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("如果您正在使用"),s("code",[this._v("@SessionScope")]),this._v("或，则同样适用"),s("code",[this._v("@RequestScope")]),this._v("。如果遇到运行时异常，表示无法找到作用域上下文，则需要使用相同的线程。")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("p",[t._v("您还可以选择将"),a("code",[t._v("hystrix.shareSecurityContext")]),t._v("属性设置为"),a("code",[t._v("true")]),t._v("。这样做会自动配置Hystrix并发策略插件挂钩，以将"),a("code",[t._v("SecurityContext")]),t._v("主线程转移到Hystrix命令使用的线程。Hystrix不会注册多个Hystrix并发策略，因此可以通过将自己声明"),a("code",[t._v("HystrixConcurrencyStrategy")]),t._v("为Spring bean 来获得扩展机制。Spring Cloud在Spring上下文中查找您的实现并将其包装在自己的插件中。")])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"_3-3健康指标"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-3健康指标","aria-hidden":"true"}},[this._v("#")]),this._v(" 3.3健康指标")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("连接断路器的状态也暴露在"),s("code",[this._v("/health")]),this._v("调用应用程序的端点中，如以下示例所示：")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-json extra-class"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"hystrix"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"openCircuitBreakers"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"StoreIntegration::getStoresByLocationLink"')]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"status"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"CIRCUIT_OPEN"')]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"status"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"UP"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])},function(){var t=this.$createElement,s=this._self._c||t;return s("h2",{attrs:{id:"_3-4-hystrix指标流"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-hystrix指标流","aria-hidden":"true"}},[this._v("#")]),this._v(" 3.4 Hystrix指标流")])},function(){var t=this.$createElement,s=this._self._c||t;return s("p",[this._v("要启用Hystrix度量标准流，请包含依赖关系"),s("code",[this._v("spring-boot-starter-actuator")]),this._v("和设置 "),s("code",[this._v("management.endpoints.web.exposure.include: hystrix.stream")]),this._v("。这样做会将"),s("code",[this._v("/actuator/hystrix.stream")]),this._v("管理端点公开，如以下示例所示：")])},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("div",{staticClass:"language-xml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-xml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("org.springframework.boot"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("spring-boot-starter-actuator"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])])}],!1,null,null,null);r.options.__file="3.断路器：Hystrix客户端.md";s.default=r.exports}}]);